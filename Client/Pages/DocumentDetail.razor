@page "/document/{DocumentId:int}"
@using StudieAssistenten.Client.Services
@using StudieAssistenten.Shared.DTOs
@using StudieAssistenten.Shared.Enums
@inject IDocumentService DocumentService
@inject NavigationManager Navigation

<PageTitle>Document Details - Studieassistenten</PageTitle>

<div class="container mt-4">
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading document...</p>
        </div>
    }
    else if (document == null)
    {
        <div class="alert alert-danger">
            <h4>Document not found</h4>
            <p>The requested document could not be found.</p>
            <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/documents"))">
                Back to Documents
            </button>
        </div>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>ðŸ“„ @document.FileName</h1>
            <button class="btn btn-secondary" @onclick="@(() => Navigation.NavigateTo("/documents"))">
                <i class="bi bi-arrow-left"></i> Back
            </button>
        </div>

        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Document Information</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Status:</dt>
                            <dd class="col-sm-8">
                                <span class="badge @GetStatusBadgeClass(document.Status)">
                                    @document.Status
                                </span>
                            </dd>

                            <dt class="col-sm-4">Size:</dt>
                            <dd class="col-sm-8">@FormatFileSize(document.FileSizeBytes)</dd>

                            <dt class="col-sm-4">Uploaded:</dt>
                            <dd class="col-sm-8">@document.UploadedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</dd>

                            @if (!string.IsNullOrEmpty(document.TeacherInstructions))
                            {
                                <dt class="col-sm-12 mt-2"><strong>Teacher Instructions:</strong></dt>
                                <dd class="col-sm-12">
                                    <div class="alert alert-info small mb-0">
                                        @document.TeacherInstructions
                                    </div>
                                </dd>
                            }
                        </dl>

                        <hr />

                        <div class="d-grid gap-2">
                            @if (document.Status == DocumentStatus.Uploaded)
                            {
                                <button class="btn btn-primary" @onclick="ProcessDocument" disabled="@isProcessing">
                                    @if (isProcessing)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        <span>Processing...</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-cpu"></i> <span>Extract Text (OCR)</span>
                                    }
                                </button>
                            }
                            else if (document.Status == DocumentStatus.OcrInProgress)
                            {
                                <button class="btn btn-info" disabled>
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    Processing...
                                </button>
                                <button class="btn btn-secondary btn-sm" @onclick="RefreshDocument">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh Status
                                </button>
                            }
                            else if (document.Status == DocumentStatus.OcrCompleted)
                            {
                                <button class="btn btn-success" disabled>
                                    <i class="bi bi-check-circle"></i> Text Extracted
                                </button>
                                <button class="btn btn-primary btn-sm" @onclick="ProcessDocument">
                                    <i class="bi bi-arrow-repeat"></i> Re-process
                                </button>
                            }
                            else if (document.Status == DocumentStatus.OcrFailed)
                            {
                                <button class="btn btn-danger" disabled>
                                    <i class="bi bi-x-circle"></i> Processing Failed
                                </button>
                                <button class="btn btn-warning btn-sm" @onclick="ProcessDocument">
                                    <i class="bi bi-arrow-repeat"></i> Retry
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Extracted Text</h5>
                        @if (!isEditing && !string.IsNullOrWhiteSpace(document.ExtractedText))
                        {
                            <button class="btn btn-sm btn-light" @onclick="StartEditing">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                        }
                    </div>
                    <div class="card-body">
                        @if (string.IsNullOrWhiteSpace(document.ExtractedText))
                        {
                            <div class="alert alert-secondary text-center py-5">
                                <i class="bi bi-file-text" style="font-size: 3rem;"></i>
                                <p class="mt-3">No text extracted yet.</p>
                                @if (document.Status == DocumentStatus.Uploaded)
                                {
                                    <p>Click "Extract Text (OCR)" to process this document.</p>
                                }
                            </div>
                        }
                        else
                        {
                            @if (isEditing)
                            {
                                <div class="mb-3">
                                    <textarea class="form-control" rows="20" @bind="editedText" style="font-family: monospace;"></textarea>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary" @onclick="SaveText" disabled="@isSaving">
                                        @if (isSaving)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                        }
                                        <span>Save Changes</span>
                                    </button>
                                    <button class="btn btn-secondary" @onclick="CancelEditing">Cancel</button>
                                </div>
                            }
                            else
                            {
                                <div class="border rounded p-3" style="white-space: pre-wrap; font-family: monospace; max-height: 600px; overflow-y: auto;">
                                    @document.ExtractedText
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">@document.ExtractedText.Length characters extracted</small>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int DocumentId { get; set; }

    private DocumentDto? document;
    private bool isLoading = true;
    private bool isProcessing = false;
    private bool isEditing = false;
    private bool isSaving = false;
    private string editedText = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadDocument();
    }

    private async Task LoadDocument()
    {
        isLoading = true;
        document = await DocumentService.GetDocumentAsync(DocumentId);
        isLoading = false;
    }

    private async Task RefreshDocument()
    {
        await LoadDocument();
    }

    private async Task ProcessDocument()
    {
        if (document == null) return;

        isProcessing = true;
        var success = await DocumentService.TriggerOcrProcessingAsync(DocumentId);
        
        if (success)
        {
            document.Status = DocumentStatus.OcrInProgress;
            // Poll for updates
            await Task.Delay(2000);
            await LoadDocument();
        }
        
        isProcessing = false;
    }

    private void StartEditing()
    {
        isEditing = true;
        editedText = document?.ExtractedText ?? string.Empty;
    }

    private void CancelEditing()
    {
        isEditing = false;
        editedText = string.Empty;
    }

    private async Task SaveText()
    {
        if (document == null) return;

        isSaving = true;
        var success = await DocumentService.UpdateExtractedTextAsync(DocumentId, editedText);
        
        if (success)
        {
            document.ExtractedText = editedText;
            isEditing = false;
        }
        
        isSaving = false;
    }

    private string GetStatusBadgeClass(DocumentStatus status)
    {
        return status switch
        {
            DocumentStatus.Uploaded => "bg-secondary",
            DocumentStatus.OcrInProgress => "bg-info",
            DocumentStatus.OcrCompleted => "bg-success",
            DocumentStatus.OcrFailed => "bg-danger",
            DocumentStatus.ProcessingInProgress => "bg-warning",
            DocumentStatus.ProcessingCompleted => "bg-success",
            DocumentStatus.ProcessingFailed => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}
