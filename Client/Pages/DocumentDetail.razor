@page "/document/{DocumentId:int}"
@using StudieAssistenten.Client.Services
@using StudieAssistenten.Shared.DTOs
@using StudieAssistenten.Shared.Enums
@inject IDocumentService DocumentService
@inject NavigationManager Navigation

<PageTitle>Document Details - Studieassistenten</PageTitle>

<div class="container mt-4">
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading document...</p>
        </div>
    }
    else if (document == null)
    {
        <div class="alert alert-danger">
            <h4>Document not found</h4>
            <p>The requested document could not be found.</p>
            <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/documents"))">
                Back to Documents
            </button>
        </div>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>ðŸ“„ @document.FileName</h1>
            <button class="btn btn-secondary" @onclick="@(() => Navigation.NavigateTo("/documents"))">
                <i class="bi bi-arrow-left"></i> Back
            </button>
        </div>

        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Document Information</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Status:</dt>
                            <dd class="col-sm-8">
                                <span class="badge @GetStatusBadgeClass(document.Status)">
                                    @document.Status
                                </span>
                            </dd>

                            <dt class="col-sm-4">Size:</dt>
                            <dd class="col-sm-8">@FormatFileSize(document.FileSizeBytes)</dd>

                            <dt class="col-sm-4">Uploaded:</dt>
                            <dd class="col-sm-8">@document.UploadedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</dd>

                            @if (!string.IsNullOrEmpty(document.TeacherInstructions))
                            {
                                <dt class="col-sm-12 mt-2"><strong>Teacher Instructions:</strong></dt>
                                <dd class="col-sm-12">
                                    <div class="alert alert-info small mb-0">
                                        @document.TeacherInstructions
                                    </div>
                                </dd>
                            }
                        </dl>

                        <hr />

                        <div class="d-grid gap-2">
                            @if (document.Status == DocumentStatus.Uploaded)
                            {
                                <button class="btn btn-primary" @onclick="ProcessDocument" disabled="@isProcessing">
                                    @if (isProcessing)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        <span>Processing...</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-cpu"></i> <span>Extract Text (OCR)</span>
                                    }
                                </button>
                            }
                            else if (document.Status == DocumentStatus.OcrInProgress)
                            {
                                <button class="btn btn-info" disabled>
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    Processing...
                                </button>
                                <button class="btn btn-secondary btn-sm" @onclick="RefreshDocument">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh Status
                                </button>
                            }
                            else if (document.Status == DocumentStatus.OcrCompleted)
                            {
                                <button class="btn btn-success" disabled>
                                    <i class="bi bi-check-circle"></i> Text Extracted
                                </button>
                                <button class="btn btn-primary btn-sm" @onclick="ProcessDocument">
                                    <i class="bi bi-arrow-repeat"></i> Re-process
                                </button>
                            }
                            else if (document.Status == DocumentStatus.OcrFailed)
                            {
                                <button class="btn btn-danger" disabled>
                                    <i class="bi bi-x-circle"></i> Processing Failed
                                </button>
                                <button class="btn btn-warning btn-sm" @onclick="ProcessDocument">
                                    <i class="bi bi-arrow-repeat"></i> Retry
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Extracted Text</h5>
                        @if (!isEditing && !string.IsNullOrWhiteSpace(document.ExtractedText))
                        {
                            <button class="btn btn-sm btn-light" @onclick="StartEditing">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                        }
                    </div>
                    <div class="card-body">
                        @if (string.IsNullOrWhiteSpace(document.ExtractedText))
                        {
                            <div class="alert alert-secondary text-center py-5">
                                <i class="bi bi-file-text" style="font-size: 3rem;"></i>
                                <p class="mt-3">No text extracted yet.</p>
                                @if (document.Status == DocumentStatus.Uploaded)
                                {
                                    <p>Click "Extract Text (OCR)" to process this document.</p>
                                }
                            </div>
                        }
                        else
                        {
                            @if (isEditing)
                            {
                                <div class="mb-3">
                                    <textarea class="form-control" rows="20" @bind="editedText" style="font-family: monospace;"></textarea>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary" @onclick="SaveText" disabled="@isSaving">
                                        @if (isSaving)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                        }
                                        <span>Save Changes</span>
                                    </button>
                                    <button class="btn btn-secondary" @onclick="CancelEditing">Cancel</button>
                                </div>
                            }
                            else
                            {
                                <div class="border rounded p-3" style="white-space: pre-wrap; font-family: monospace; max-height: 600px; overflow-y: auto;">
                                    @document.ExtractedText
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">@document.ExtractedText.Length characters extracted</small>
                                </div>
                            }
                        }
                    </div>
                </div>

                @* AI Content Generation Section *@
                @if (!string.IsNullOrWhiteSpace(document.ExtractedText))
                {
                    <div class="card mt-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">ðŸ¤– AI-Powered Study Tools</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Generate study materials from the extracted text using AI</p>
                            
                            <div class="mb-3">
                                <label for="teacherInstructions" class="form-label">Additional Instructions (Optional)</label>
                                <textarea class="form-control" id="teacherInstructions" rows="2" 
                                          @bind="teacherInstructions" 
                                          placeholder="E.g., 'Focus on chapters 1-3' or 'Include questions about terminology'"></textarea>
                            </div>

                            <div class="row g-2">
                                <div class="col-md-4">
                                    <button class="btn btn-primary w-100" @onclick="@(() => GenerateContent(ProcessingType.Flashcards))" disabled="@isGenerating">
                                        @if (isGenerating && generatingType == ProcessingType.Flashcards)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-card-list me-2"></i>
                                        }
                                        Generate Flashcards
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-warning w-100" @onclick="@(() => GenerateContent(ProcessingType.PracticeTest))" disabled="@isGenerating">
                                        @if (isGenerating && generatingType == ProcessingType.PracticeTest)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-clipboard-check me-2"></i>
                                        }
                                        Generate Practice Test
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-success w-100" @onclick="@(() => GenerateContent(ProcessingType.Summary))" disabled="@isGenerating">
                                        @if (isGenerating && generatingType == ProcessingType.Summary)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-file-text me-2"></i>
                                        }
                                        Generate Summary
                                    </button>
                                </div>
                            </div>

                            @if (!string.IsNullOrWhiteSpace(generationError))
                            {
                                <div class="alert alert-danger mt-3">
                                    @generationError
                                </div>
                            }

                            @if (generatedContents.Any())
                            {
                                <hr class="my-4" />
                                <h6>Generated Content</h6>
                                <div class="list-group">
                                    @foreach (var content in generatedContents)
                                    {
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-1">
                                                        @content.Title
                                                        <span class="badge @GetProcessingTypeBadge(content.ProcessingType) ms-2">
                                                            @content.ProcessingType
                                                        </span>
                                                    </h6>
                                                    <small class="text-muted">
                                                        Generated @content.GeneratedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                                                        @if (content.FlashcardsCount > 0)
                                                        {
                                                            <span> â€¢ @content.FlashcardsCount flashcards</span>
                                                        }
                                                    </small>
                                                </div>
                                                <button class="btn btn-sm btn-primary" @onclick="@(() => ViewGeneratedContent(content.Id))">
                                                    View
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        @* Generated Content Modal *@
        @if (selectedContent != null)
        {
            <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">@selectedContent.Title</h5>
                            <button type="button" class="btn-close" @onclick="CloseModal"></button>
                        </div>
                        <div class="modal-body">
                            @if (selectedContent.ProcessingType == ProcessingType.Flashcards && selectedContent.Flashcards.Any())
                            {
                                <div class="flashcards-container">
                                    @foreach (var flashcard in selectedContent.Flashcards)
                                    {
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <h6 class="text-primary">Question @(flashcard.Order + 1)</h6>
                                                <p><strong>@flashcard.Question</strong></p>
                                                <hr />
                                                <h6 class="text-success">Answer</h6>
                                                <p>@flashcard.Answer</p>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div style="white-space: pre-wrap;">@selectedContent.Content</div>
                            }
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseModal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public int DocumentId { get; set; }

    private DocumentDto? document;
    private bool isLoading = true;
    private bool isProcessing = false;
    private bool isEditing = false;
    private bool isSaving = false;
    private string editedText = string.Empty;
    private bool isGenerating = false;
    private ProcessingType? generatingType = null;
    private string teacherInstructions = string.Empty;
    private string generationError = string.Empty;
    private List<GeneratedContentDto> generatedContents = new();
    private GeneratedContentDto? selectedContent = null;

    [Inject]
    private ContentGenerationService ContentGenerationService { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await LoadDocument();
        await LoadGeneratedContents();
    }

    private async Task LoadDocument()
    {
        isLoading = true;
        document = await DocumentService.GetDocumentAsync(DocumentId);
        isLoading = false;
    }

    private async Task LoadGeneratedContents()
    {
        try
        {
            generatedContents = await ContentGenerationService.GetDocumentContentsAsync(DocumentId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading generated contents: {ex.Message}");
            generatedContents = new();
        }
    }

    private async Task GenerateContent(ProcessingType type)
    {
        if (document == null) return;

        isGenerating = true;
        generatingType = type;
        generationError = string.Empty;

        try
        {
            var request = new GenerateContentRequestDto
            {
                DocumentId = DocumentId,
                ProcessingType = type,
                TeacherInstructions = string.IsNullOrWhiteSpace(teacherInstructions) ? null : teacherInstructions
            };

            var result = await ContentGenerationService.GenerateContentAsync(request);
            
            if (result != null)
            {
                await LoadGeneratedContents();
                teacherInstructions = string.Empty;
            }
        }
        catch (Exception ex)
        {
            generationError = $"Error generating content: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
            generatingType = null;
        }
    }

    private async Task ViewGeneratedContent(int contentId)
    {
        try
        {
            selectedContent = await ContentGenerationService.GetContentAsync(contentId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading content: {ex.Message}");
        }
    }

    private void CloseModal()
    {
        selectedContent = null;
    }

    private string GetProcessingTypeBadge(ProcessingType type)
    {
        return type switch
        {
            ProcessingType.Flashcards => "bg-primary",
            ProcessingType.PracticeTest => "bg-warning text-dark",
            ProcessingType.Summary => "bg-success",
            _ => "bg-secondary"
        };
    }

    private async Task RefreshDocument()
    {
        await LoadDocument();
    }

    private async Task ProcessDocument()
    {
        if (document == null) return;

        isProcessing = true;
        var success = await DocumentService.TriggerOcrProcessingAsync(DocumentId);
        
        if (success)
        {
            document.Status = DocumentStatus.OcrInProgress;
            // Poll for updates
            await Task.Delay(2000);
            await LoadDocument();
        }
        
        isProcessing = false;
    }

    private void StartEditing()
    {
        isEditing = true;
        editedText = document?.ExtractedText ?? string.Empty;
    }

    private void CancelEditing()
    {
        isEditing = false;
        editedText = string.Empty;
    }

    private async Task SaveText()
    {
        if (document == null) return;

        isSaving = true;
        var success = await DocumentService.UpdateExtractedTextAsync(DocumentId, editedText);
        
        if (success)
        {
            document.ExtractedText = editedText;
            isEditing = false;
        }
        
        isSaving = false;
    }

    private string GetStatusBadgeClass(DocumentStatus status)
    {
        return status switch
        {
            DocumentStatus.Uploaded => "bg-secondary",
            DocumentStatus.OcrInProgress => "bg-info",
            DocumentStatus.OcrCompleted => "bg-success",
            DocumentStatus.OcrFailed => "bg-danger",
            DocumentStatus.ProcessingInProgress => "bg-warning",
            DocumentStatus.ProcessingCompleted => "bg-success",
            DocumentStatus.ProcessingFailed => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}
