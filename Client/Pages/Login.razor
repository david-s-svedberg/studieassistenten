@page "/login"
@inject NavigationManager Navigation

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h1>Studieassistenten</h1>
            <p class="subtitle">Sign in to continue</p>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" role="alert">
                @errorMessage
            </div>
        }

        <div class="login-content">
            <a href="/api/auth/login-google" class="btn btn-google">
                <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                    <path fill="none" d="M0 0h48v48H0z"/>
                </svg>
                <span>Sign in with Google</span>
            </a>

            @if (!string.IsNullOrEmpty(deniedEmail))
            {
                <div class="access-denied-info">
                    <p><strong>Access Denied</strong></p>
                    <p>The email address <code>@deniedEmail</code> is not authorized to access this application.</p>
                    <p>Please contact the administrator if you believe this is an error.</p>
                </div>
            }
        </div>

        <div class="login-footer">
            <p>Only authorized users can access this application.</p>
        </div>
    </div>
</div>

<style>
    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
    }

    .login-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        max-width: 450px;
        width: 100%;
        padding: 40px;
    }

    .login-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .login-header h1 {
        color: #333;
        font-size: 28px;
        margin: 0 0 10px 0;
        font-weight: 600;
    }

    .subtitle {
        color: #666;
        font-size: 16px;
        margin: 0;
    }

    .login-content {
        margin: 30px 0;
    }

    .btn-google {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        width: 100%;
        padding: 14px 24px;
        background: white;
        border: 2px solid #ddd;
        border-radius: 8px;
        color: #333;
        font-size: 16px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-google:hover {
        background: #f8f9fa;
        border-color: #bbb;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-google svg {
        flex-shrink: 0;
    }

    .alert {
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 20px;
    }

    .alert-danger {
        background-color: #f8d7da;
        border: 1px solid #f5c2c7;
        color: #842029;
    }

    .access-denied-info {
        margin-top: 24px;
        padding: 16px;
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
        color: #856404;
    }

    .access-denied-info p {
        margin: 8px 0;
        font-size: 14px;
    }

    .access-denied-info code {
        background: rgba(0, 0, 0, 0.1);
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
    }

    .login-footer {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }

    .login-footer p {
        color: #666;
        font-size: 14px;
        margin: 0;
    }
</style>

@code {
    private string? errorMessage;
    private string? deniedEmail;

    protected override void OnInitialized()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var error = GetQueryParameter(uri.Query, "error");

        if (!string.IsNullOrEmpty(error))
        {
            errorMessage = error switch
            {
                "access_denied" => "Access denied. Your email address is not authorized.",
                "auth_failed" => "Authentication failed. Please try again.",
                "no_email" => "No email address found in your Google account.",
                "user_creation_failed" => "Failed to create user account. Please try again.",
                "callback_failed" => "Authentication callback failed. Please try again.",
                _ => "An error occurred during sign in. Please try again."
            };
        }

        var email = GetQueryParameter(uri.Query, "email");
        if (!string.IsNullOrEmpty(email))
        {
            deniedEmail = Uri.UnescapeDataString(email);
        }
    }

    private string? GetQueryParameter(string queryString, string key)
    {
        if (string.IsNullOrEmpty(queryString) || queryString.Length < 2)
            return null;

        queryString = queryString.StartsWith("?") ? queryString.Substring(1) : queryString;
        var pairs = queryString.Split('&');

        foreach (var pair in pairs)
        {
            var parts = pair.Split('=');
            if (parts.Length == 2 && parts[0] == key)
            {
                return parts[1];
            }
        }

        return null;
    }
}
