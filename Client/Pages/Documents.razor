@page "/documents"
@using StudieAssistenten.Client.Services
@using StudieAssistenten.Shared.DTOs
@using StudieAssistenten.Shared.Enums
@inject IDocumentService DocumentService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>My Documents - Studieassistenten</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ðŸ“„ My Study Materials</h1>
        <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/upload"))">
            <i class="bi bi-plus-circle"></i> Upload New Material
        </button>
    </div>

    @if (!string.IsNullOrWhiteSpace(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>@errorMessage
            <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)" aria-label="Close"></button>
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading your documents...</p>
        </div>
    }
    else if (documents == null || !documents.Any())
    {
        <div class="alert alert-info text-center py-5">
            <h4>No documents yet</h4>
            <p>Upload your first study material to get started!</p>
            <button class="btn btn-primary mt-3" @onclick="@(() => Navigation.NavigateTo("/upload"))">
                Upload Material
            </button>
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var doc in documents)
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title text-truncate" title="@doc.FileName">
                                @GetFileIcon(doc.FileName) @doc.FileName
                            </h5>
                            <p class="card-text text-muted small">
                                <i class="bi bi-calendar"></i> @doc.UploadedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                            </p>
                            <p class="card-text">
                                <span class="badge @GetStatusBadgeClass(doc.Status)">
                                    @doc.Status
                                </span>
                            </p>

                            @if (!string.IsNullOrEmpty(doc.ExtractedText))
                            {
                                <p class="card-text small">
                                    <strong>Extracted text:</strong> 
                                    @(doc.ExtractedText.Length > 100 ? doc.ExtractedText.Substring(0, 100) + "..." : doc.ExtractedText)
                                </p>
                            }
                        </div>
                        <div class="card-footer bg-white border-top-0">
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-sm btn-outline-primary" 
                                       @onclick="@(() => ViewDocument(doc.Id))">
                                    <i class="bi bi-eye"></i> View Details
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                       @onclick="@(() => DeleteDocument(doc.Id))">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<DocumentDto>? documents;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadDocuments();
    }

    private async Task LoadDocuments()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            documents = await DocumentService.GetDocumentsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load documents: {ex.Message}";
            documents = new List<DocumentDto>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ViewDocument(int documentId)
    {
        Navigation.NavigateTo($"/document/{documentId}");
    }

    private string? errorMessage;

    private async Task DeleteDocument(int documentId)
    {
        var doc = documents?.FirstOrDefault(d => d.Id == documentId);
        if (doc == null) return;

        if (!await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{doc.FileName}'? This action cannot be undone."))
        {
            return;
        }

        try
        {
            if (await DocumentService.DeleteDocumentAsync(documentId))
            {
                await LoadDocuments();
                errorMessage = null;
            }
            else
            {
                errorMessage = "Failed to delete the document. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting document: {ex.Message}";
        }
    }

    private string GetFileIcon(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".pdf" => "ðŸ“„",
            ".jpg" or ".jpeg" or ".png" => "ðŸ–¼ï¸",
            ".txt" => "ðŸ“",
            ".docx" => "ðŸ“˜",
            _ => "ðŸ“Ž"
        };
    }

    private string GetStatusBadgeClass(DocumentStatus status)
    {
        return status switch
        {
            DocumentStatus.Uploaded => "bg-secondary",
            DocumentStatus.OcrInProgress => "bg-info",
            DocumentStatus.OcrCompleted => "bg-success",
            DocumentStatus.OcrFailed => "bg-danger",
            DocumentStatus.ProcessingInProgress => "bg-warning",
            DocumentStatus.ProcessingCompleted => "bg-success",
            DocumentStatus.ProcessingFailed => "bg-danger",
            _ => "bg-secondary"
        };
    }
}
